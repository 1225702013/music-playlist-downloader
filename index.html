<!DOCTYPE html>
<html>

<body class="mdui-theme-accent-blue mdui-list mdui-appbar-with-toolbar padding-top">
    <link rel="stylesheet" href="./add/mdui/css/mdui.min.css" />
    <script src="./add/mdui/js/mdui.min.js"></script>
    <script src='./add/jq.js'></script>

    <div class='mdui-appbar mdui-shadow-2 mdui-appbar-fixed' style='max-width: 700px'>
        <div class='mdui-toolbar mdui-color-white'>
            <select id="playlisttyp" class="mdui-select">
                <option value="netease">网易云音乐</option>
                <option value="tencent">QQ音乐</option>
                <option value="xiami">虾米音乐</option>
                <option value="kugou">酷狗音乐</option>
                <option value="baidu">百度音乐</option>
            </select>
            <div class='mdui-textfield'>
                <input id='playlistid' class='mdui-textfield-input' placeholder='请输入歌单id'>
            </div>
            <div class='mdui-toolbar-spacer'></div>
            <a href='javascript:render(1)' class='mdui-text mdui-text-color-blue'>下载全部</a>
        </div>
        <div class='mdui-toolbar mdui-color-white'>
            <a href="javascript:pre()">
                <i class='mdui-icon material-icons'>skip_previous</i>
            </a>
            <a href="javascript:rnd()">
                <i class="mdui-icon material-icons">youtube_searched_for</i>
            </a>
            <a href="javascript:nxt()">
                <i class='mdui-icon material-icons'>skip_next</i>
            </a>
            <audio id="player" src="" controls="controls" autoplay="autoplay">
            </audio>
        </div>
    </div>
    <p></p>
    <li class="mdui-list-item"></li>
    <li class="mdui-list-item"></li>
    <ul id="songlist" class="mdui-list mdui-appbar-with-toolbar padding-top">
    </ul>
    <script>
        function sleep(delay) {
            var start = (new Date()).getTime();
            while ((new Date()).getTime() - start < delay) {
                continue;
            }
        }

        var is_downloading = 0,
            list,
            now = 0;

        function node(i) {
            return "<li class='mdui-list-item mdui-ripple' style='max-width: 700px;'>\
                <div class='mdui-list-item-avatar'><img src='" + list[i].cover + "'></div>\
                <a href=\"javascript:play(" + i + ")\" class='mdui-list-item-content'>\
                    <div class='mdui-list-item-title'>" + list[i].name + "</div>\
                    <div class='mdui-list-item-text'>" + list[i].artist + "</div>\
                </a>\
                <a href=\"javascript:download(" + i + ")\">\
                    \<i class='mdui-list-item-icon mdui-icon material-icons'>file_download</i>\
                </a>\
            </li>";
        }

        function play(i) {
            $("#player").attr("src", list[i].url);
            $("#player").play();
        }

        function pre() {
            if (now > 0) play(--now);
            else play(now = list.length - 1);
        }

        function nxt() {
            if (now < list.length - 1) play(++now);
            else play(now = 0)
        }

        function rnd() {
            play(Math.floor((Math.random() * (list.length - 1))));
        }
        document.getElementById("player").addEventListener('ended', function () {
            rnd();
        });

        function download(id) {
            var url = list[id].url,
                filename = list[id].artist + " - " + list[id].name + ".mp3";
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = "blob";
            xhr.onload = function () {
                is_downloading = 1;
                if (this.status === 200) {
                    var blob = this.response;
                    var a = document.createElement('a');
                    a.download = filename;
                    a.href = window.URL.createObjectURL(blob);
                    a.click();
                    is_downloading = 0;
                }
                while (is_downloading) continue;
                sleep(1100);
            };
            xhr.send();
        }

        function render(b) {
            mdui.snackbar({
                message: '加载中',
                timeout: 500,
                position: 'top'
            });
            if (b == 0) $("#songlist").html("");
            var id = $('#playlistid').val(),
                typ = $('#playlisttyp').val();
            var t = $.ajax({
                url: "https://api.i-meto.com/meting/api?server=" + typ + "&type=playlist&id=" + id,
                async: false
            }).responseText;
            console.log(t);
            list = JSON.parse(t);
            console.log(list);
            for (i in list)
                if (b == 0) $("#songlist").append(node(i));
                else download(i);

            mdui.mutation();
            mdui.snackbar({
                message: '加载完毕',
                timeout: 500,
                position: 'top'
            });
        }
        $('#playlistid').change(function () {
            render(0);
        });
    </script>
</body>

</html>